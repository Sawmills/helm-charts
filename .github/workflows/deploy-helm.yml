name: Deploy Helm Chart
run-name: Deploy Helm Chart - ${{ inputs.environment }} by @${{ github.actor }}

permissions:
  id-token: write
  contents: write

on:
  workflow_call:
    inputs:
      environment:
        type: string
        required: true
        description: Environment to deploy to (e.g., staging, preprod, prod)
      chart_version:
        type: string
        required: true
        description: Version of the Helm chart to deploy
    secrets:
      API_KEY:
        required: true
        description: API key for the Sawmills Metrics API endpoint
      O11Y_API_KEY:
        required: true
        description: API key for the Sawmills Metrics API endpoint
      QMP_FOLDER:
        required: true
        description: Folder name for the Quota Management Processor
      O11Y_QMP_FOLDER:
        required: true
        description: Folder name for the Quota Management Processor for O11y

jobs:
  deploy-helm-chart:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Deploy Helm chart
        uses: azure/setup-helm@v3
        with:
          version: latest

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.EKS_ROLE }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Update kube config
        run: aws eks update-kubeconfig --name sawmills-plat-ue1-${{ inputs.environment }}-eks-cluster

      - name: Deploy Helm chart
        run: |
          CHART_VERSION=${{ inputs.chart_version }}
          if [[ $CHART_VERSION == v* ]]; then
            CHART_VERSION=${CHART_VERSION:1}
          fi

          helm upgrade --install sawmills-collector \
            oci://public.ecr.aws/s7a5m1b4/sawmills-collector-chart \
            --version ${CHART_VERSION} \
            --namespace sawmills-collector \
            --create-namespace \
            --values deploy/values.yaml \
            --set quotamgmtprocessor.folder_name=${{ secrets.QMP_FOLDER }} \
            --set quotamgmtprocessor.s3_bucket=sawmills-plat-ue1-${{ inputs.environment }}-quotas \
            --set prometheusremotewrite.api_key=${{ secrets.API_KEY }} \
            --set "otelCollectorConfig.processors.attributes.actions[1].value=${{ inputs.environment }}"
